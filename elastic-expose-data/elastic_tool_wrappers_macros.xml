<?xml version="1.0" encoding="UTF-8"?>
<macros>
  <xml name="rmarkdown_requirements">
    <requirement type="package" version="1.15.0.6-0">pandoc</requirement>
    <requirement type="package" version="1.6">r-rmarkdown</requirement>
  </xml>
  <xml name="stdio">
    <stdio>
      <regex match="XXX" source="stderr" level="warning" description="Check the tool log output file for more details."/>
    </stdio>
  </xml>
  <!--OPTION/ARGUMENT PAIRS and INPUT types-->

  <!--input path-->
  <xml name="option_argument_path_relative_to_a_tool">
    <repeat name="option_argument_path_relative_to_a_tool_repeat" title="INPUT DATA PATH: relative to a tool output directory" min="0" default="0">
      <param name="a_tool_output_dir" type="data" optional="false" multiple="false" label="a tool output directory"/>
      <param type="text" name="value" optional="true" label="relative path"/>
    </repeat>
  </xml>

  <!--shell command fragment-->
  <xml name="shell_command">
    <command><![CDATA[
        echo $tool_name &&

        ############ first, create a directory to store all files
        mkdir -p $report.files_path &&


        ############ save the tool installation directory to an environment variable
        export TOOL_INSTALL_DIR='${__tool_directory__}' &&


        #########################
        ##
        ## save user input option/argument pairs into a file
        ##
        #########################

        ## first line will be the header
        echo 'tool_output_dir|relative_path' > '$report.files_path/options_and_arguments.txt' &&



        ####################################################
        ## loop through repeats to get option/argument pairs
        ####################################################


        ############ option_argument_path_relative_to_a_tool
        #for i in $option_argument_path_relative_to_a_tool_repeat:
             #set $item = str($i.a_tool_output_dir) + "|" + str($i.value)
             echo '$item' >> '$report.files_path/options_and_arguments.txt' &&
        #end for


        ############ output_set
        ## '$report'
        ## '$report.files_path'
        #######################
        export REPORT='$report' &&
        export TOOL_LOG='$tool_log' &&
        export REPORT_FILES_PATH='$report.files_path' &&


        ############ run render R script to render R markdowns
        Rscript '${__tool_directory__}/elastic_tool_render.R'

        ]]></command>
  </xml>

  <!--<xml name="output_set">-->
    <!--<data format="html" name="report" label="${tool.name} report"/>-->
    <!--<data format="txt" name="tool_log" label="${tool.name} log"/>-->
    <!--<collection type="list" name="list_collection">-->
      <!--<discover_datasets pattern="__name_and_ext__" directory="list" />-->
    <!--</collection>-->
    <!--<collection type="paired" name="list_collection">-->
      <!--<discover_datasets pattern="__name_and_ext__" directory="paired_dir" />-->
    <!--</collection>-->
    <!--<collection type="list:paired" name="list_collection">-->
      <!--<discover_datasets pattern="(?P&lt;identifier_0&gt;[^_]+)_(?P&lt;identifier_1&gt;[^_]+)\.(?P&lt;ext&gt;[^\._]+)?"-->
                         <!--directory="list_paired"/>-->
    <!--</collection>-->
  <!--</xml>-->

  <!--tool citations-->
  <xml name="citations">
    <citation type="bibtex"><![CDATA[
            @article{allaire2016rmarkdown,
            title={rmarkdown: Dynamic Documents for R, 2016},
            author={Allaire, J and Cheng, Joe and Xie, Yihui and McPherson, Jonathan and Chang, Winston and Allen, Jeff
            and Wickham, Hadley and Atkins, Aron and Hyndman, Rob},
            journal={R package version 0.9},
            volume={6},
            year={2016}
            }
        ]]></citation>
    <citation type="bibtex"><![CDATA[
            @book{xie2015elastic,
            title={Dynamic Documents with R and knitr},
            author={Xie, Yihui},
            volume={29},
            year={2015},
            publisher={CRC Press}
            }
        ]]></citation>
  </xml>
</macros>
