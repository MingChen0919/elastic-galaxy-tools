<macros>

    <xml name="rmarkdown_requirements">
        <requirement type="package" version="1.15.0.6-0">pandoc</requirement>
        <requirement type="package" version="1.6">r-rmarkdown</requirement>
        <requirement type="package" version="1.1.1">r-tidyverse</requirement>
    </xml>

    <xml name="stdio">
        <stdio>
            <regex match="XXX" source="stderr" level="warning"
                   description="Check the tool log output file for more details."/>
        </stdio>
    </xml>

    <xml name="function_components">
        <repeat name="function_components" title="Call a function" min="1" default="1">
            <param type="select" name="function_name" multiple="false" label="==== Call function ====">
                <option value="ggplot" selected="false">ggplot</option>
                <option value="aes" selected="false">ggplot</option>
                <option value="read.table" selected="false">read.table</option>
                <option value="write.csv" selected="false">write.csv</option>
            </param>
            <expand macro="function_arguments" />
            <param type="select" name="operator" label="connect to next function">
                <sanitizer>
                    <valid initial="string.printable"/>
                </sanitizer>
                <option value="%>%" selected="true">pipe (%>%)</option>
                <option value="+" selected="false">plus (+)</option>
            </param>
        </repeat>
    </xml>

    <xml name="function_arguments">
        <repeat name="regular_argument_value" title="Argument value: from user input" min="0" default="0">
            <param type="text" name="argument" label="argument"  />
            <param type="text" name="argument_value"  label="argument value"  />
            <param type="select" name="argument_value_type"  label="argument type">
                <option value="string" selected="true">string</option>
                <option value="numeric" selected="false">numeric</option>
                <option value="boolean" selected="false">boolean</option>
                <option value="variable" selected="false">variable</option>
            </param>
        </repeat>
        <repeat name="rdata_argument_value" title="Argument value: from RData" min="0" default="0">
            <param type="text" name="argument" label="argument"  />
            <param type="data" format="rdata" name="argument_value" optional="false" label="RData output"  />
        </repeat>
    </xml>


    <!--output set-->
    <xml name="output_set">
        <data format="html" name="report" label="${tool.name} report"/>
        <data format="txt" name="tool_help_doc" label="${tool.name} help doc"/>
        <data format="txt" name="tool_log" label="${tool.name} log" />
    </xml>


    <!--shell command fragment-->
    <xml name="shell_command">
        <command><![CDATA[

        ############ 1. create a directory to store all files
        mkdir -p $report.files_path &&


        ############ 2. save the tool installation directory to an environment variable
        export TOOL_INSTALL_DIR='${__tool_directory__}' &&


        ############ 3. save user inputs into arguments.txt

        ############    3.1 table header
        echo 'function|input_type|argument|argument_value|argument_value_type|operator' > $report.files_path/arguments.txt &&


        ############    3.2 loop through function component repeat
        #for $fun_component in $function_components:
            #for reg_arg in $fun_component.regular_argument_value
                echo '$fun_component.function_name|regular|$reg_arg.argument|$reg_arg.argument_value|$reg_arg.argument_value_type|$fun_component.operator' >> $report.files_path/arguments.txt &&
            #end for

            #for rdata_arg in $fun_component.rdata_argument_value
                echo '$fun_component.function_name|rdata|$rdata_arg.argument|$rdata_arg.argument_value|rdata|$fun_component.operator' >> $report.files_path/arguments.txt &&
            #end for
        #end for

        ############ output_set
        ## '$report'
        ## '$report.files_path'
        ## '$tool_help_doc'
        ## '$tool_log'
        #######################
        export REPORT='$report' &&
        export REPORT_FILES_PATH='$report.files_path' &&
        export TOOL_HELP_DOC='$tool_help_doc' &&
        export TOOL_LOG='$tool_log' &&


        ############ run render R script to render R markdowns
        Rscript '${__tool_directory__}/elastic_r_package_render.R'

        ]]></command>
    </xml>

    <!--tool citations-->
    <xml name="citations">
        <citation type="bibtex"><![CDATA[
            @article{allaire2016rmarkdown,
            title={rmarkdown: Dynamic Documents for R, 2016},
            author={Allaire, J and Cheng, Joe and Xie, Yihui and McPherson, Jonathan and Chang, Winston and Allen, Jeff
            and Wickham, Hadley and Atkins, Aron and Hyndman, Rob},
            journal={R package version 0.9},
            volume={6},
            year={2016}
            }
        ]]></citation>
        <citation type="bibtex"><![CDATA[
            @book{xie2015elastic,
            title={Dynamic Documents with R and knitr},
            author={Xie, Yihui},
            volume={29},
            year={2015},
            publisher={CRC Press}
            }
        ]]></citation>
    </xml>
</macros>
